# 5 複数サーバー/区画へのアクセス

「IBM i サービス」はSQLインターフェースを採用しており、「分散リレーショナル データベース体系」(DRDA)で相互接続された複数のIBM i を容易に集中管理できます。

?> DRDA/DDMは業界団体である「The Open Group」が公開している、異なるプラットフォーム上のアプリケーションとデータベース・システム間の通信を可能にするオープンなアーキテクチャです。

下図は、複数のサーバー/区画にまたがるIBM i を集中管理しているイメージです。

![5_複数サーバー_区画へのアクセス.jpg](/files/5_複数サーバー_区画へのアクセス.jpg)

メニュー画面から「IBM iサービス」を利用した運用アプリケーションを呼出し、対象とする複数区画のCPU使用率、ディスク使用率、稼働時間、区画間の時間差などを、まとめて表示・管理します。

同様の仕組みを利用し、ユーザー・プロフィールやプログラム、ファイルなどのオブジェクト状況、システム値など各種設定、PTF適用状況など、サーバー/区画間で「IBM iサービス」で取得可能な様々な情報を比較できます。本番以外に、待機機・災対機・検証区画・ステージング区画などを利用しているケースで、複数環境の運用・管理や、整合性の調査・維持に役立つでしょう。

以降では具体的な応用例を紹介します。

<p>　</p>

---

下図は複数サーバー/区画のシステム状況をまとめて表示する画面の例です。

![5_複数サーバー_区画へのアクセス2.jpg](/files/5_複数サーバー_区画へのアクセス2.jpg)

3行目に対象区画の割り当てコア数合計、この時点で使用されているコア数、システムの総区画数が表示されます。

明細の、それぞれ1行目に、各区画の名前、割り当てコア数、CPU共有方式、最大CPU使用率、CPU使用率をコア数換算した数値が、2行目に総ジョブ数、活動ジョブ数、最大ジョブ数、ASP1の容量、ASP1の容量使用率が、一覧表示されています。

次のような事項の判断材料になるでしょう。

* 同一サーバーに共存している区画のうち、特定の区画のみCPU使用率が継続して高い値であれば、他の区画からCPUを移動すべきでしょう。
* 全ての区画のCPU使用率が継続して高い数値となっている場合、CPUコアの追加が必要かもしれません。
* 総ジョブ数(実行中ではないがジョブ・テーブルを使っているジョブを含む)が、最大ジョブ数に近い場合、DSPJOBTBLコマンドで使用状況明細を確認する、スプールを削除してジョブ・テーブルを開放する、CHGIPLAコマンドのCPRJOBTBLパラメーターでIPL時にジョブ・テーブルを圧縮する、システム値QMAXJOBを増やす、などを検討します。
* ASP1(システムASP)の使用率が高い場合は早急な対処が必要です。ASP1の使用率が100%に達するとシステムが停止するので、不要なオブジェクトを削除する、ディスクを追加する、など、ディスクの空き容量を確保します。

<p>　</p>

---

次の例では、サーバー/区画の時刻に関する情報を表示しています。

![5_複数サーバー_区画へのアクセス3.jpg](/files/5_複数サーバー_区画へのアクセス3.jpg)

各明細行の、1行目に、各区画の名前、区画の現在日時、基礎となる区画との時刻差異(Λ秒)、次回IPL日時、2行目に、SCPFジョブの開始時刻、連続稼働時間が、表示されます。

次回IPL日時は、システム値QIPLDATTIMが設定されている場合のみ表示されます。区画が開始された正確な日時を取得する事はできないため、最初に起動するシステム・ジョブであるSCPFジョブの開始時刻の1～3分前が起動時点と推定できます。

この画面から何が判るかを考えてみましょう。

* サーバー/区画間の「時刻差異(Λ秒)」が大きい(例えば分単位の差異がある)と、正確な時刻での実施を想定した連携処理に支障が発生する可能性があります。また、「本番→待機」や「本番→災対」のように、複数台で同期を行っている場合も大きな時刻差は望ましくありません。必要な場合はSNTPサーバーを利用し、時刻同期を行うなどの対策が推奨されます。
* 画面上では3番目の区画の「通算稼働時間」が210日を超えています。IBM iをどのくらいの頻度(間隔)でIPLすべきか、明確な指針は存在しません。毎日IPLするケースもあれば、年に1回程度(基本は無停止)のケースもあります。このため、運用上はIPLを必要とする作業(PTFの適用やハードウェアの保守など)のため、1か月に1回、半日～1日程度の計画停止をスケジュールすることをお勧めします。
* 画面の「次回IPL日時」は、「電源オンおよび電源オフ・タスク」(GO POWERメニュー)などでシステム値「QIPLDATTIM」が設定されている場合に表示されます。各サーバー/区画の次回のIPLのタイミングをクイックに確認できれば、業務や運用への影響の有無の判断が容易になるでしょう。

<p>　</p>

---

最後の例はシステム値の比較です。各サーバー/区画のシステム値と、ベースとなる区画との差異を印刷出力します。下図が出力のイメージです。

![5_複数サーバー_区画へのアクセス4.jpg](/files/5_複数サーバー_区画へのアクセス4.jpg)

例では3つの区画を比較しており、「L?_VALUE」はその区画のシステム値の設定値をそのままリストしています。「L?_DIFF」はベース区画(例ではL1)との差異を、差異無しは「0」、数値項目の差異ありは「1」、文字項目の差異ありは「2」で出力します。
差異のあるシステム値を調べることで、初期構築時の設定確認や、運用時における定期的な区画間整合性チェックをクイックに行えます。

同様の方法で、ユーザー・プロフィールや、PTFレベル、各種オブジェクトなどに対し、サーバー/区画間差異を出力するSQLを用意すれば、確実なサーバー運用が容易になるでしょう。

<br>

「IBM i サービス」を複数区画の運用に利用した例を紹介しました。「IBM i サービス」は、他にも、アプリケーション保守や、セキュリティ管理など、多くの分野に活用できます。日々のオペレーションをモダナイゼーションする、強力なツールといえます。

<p>　</p>

---

### 参考：DRDAによるSQLアクセス

この章の冒頭で述べたように、他のサーバー/区画へSQLで透過的にアクセスするには、DRDA (分散リレーショナル データベース体系)で接続できる事が前提です。

<br>

IBM iでは次のような項目がDRDA構成に関係します。

* CHGDDMTCPAコマンドでDRDAサーバーの基本設定を実施。設定には、サーバーの自動開始、パスワード機密保護の最低レベル、接続要求で許可される最低強度の暗号化アルゴリズムが含まれる。

?> セキュリティの観点から、「PWDRQD」(最低の認証方式)パラメーターの値は、「*USRENCPWD」(ユーザーIDおよび関連した暗号化パスワード)に設定することをお勧めします。パスワード不要に設定する事も可能ですが、セキュリティ・ホールになる事を考慮すべきでしょう。

* ADDRDBDIREコマンド(またはWRKRDBDIREコマンドのオプション「1=追加」)で、リモート・ロケーションを「*LOCAL」に設定し、このサーバー自身のデータベースを指定。

?> 「*LOCAL」項目の変更には所定の手順があります。詳細は「*LOCALディレクトリー項目」(https://www.ibm.com/support/knowledgecenter/ja/ssw_ibm_i_73/ddp/rbal1localentry.htm )、および、「Changing the *LOCAL Relational Database Directory Entry」(https://www.ibm.com/support/pages/changing-local-relational-database-directory-entry 英文)を参照。

* DRDA接続を行うリモート・サーバー(データベース)をADDRDBDIREコマンド(またはWRKRDBDIREコマンドのオプション「1=追加」)で追加。RDB名、リモート・サーバーのIPアドレス、リモート認証方式、暗号化アルゴリズムリモートを指定。

<br>

リモート・サーバーにDRDA接続を行う場合、例えば次のようなSQLを実行します。
```
CONNECT TO (リモート・サーバー) USER (リモートのユーザーID) 
                               USING '(リモートのユーザーのパスワード)'
```

複数のリモート・サーバーへCONNECTで接続し、「SET CONNECTION (リモート・サーバー)」でデフォルトのリモート・サーバーを切り替えることができます。

?> 基本的に一度確立した接続は維持されます。ただし、TCP/IP通信の経路が切断される場合は、処理の都度、接続→切断を行う、あるいは、接続エラーを検出してリカバリーを行う、などの考慮が必要でしょう。詳細は「Database Host Server Connections Drop after a Period of Inactivity」(https://www.ibm.com/support/pages/database-host-server-connections-drop-after-period-inactivity 英文)などを参照。

<br>

リモート・サーバーへの接続時に、ユーザーIDとパスワードを打鍵、あるいは、コードに記述するのは、管理およびセキュリティの面から望ましくないケースがあります。これを緩和するため、接続設定とセキュリティ運用を強化・効率化する方法が提供されています。

?> 詳細はIBM Knowledge Centerの「TCP/IP ネットワークでのクライアントのセキュリティー」(https://www.ibm.com/support/knowledgecenter/ja/ssw_ibm_i_73/ddp/rbal1sourcesecurity.htm )を参照。

* ローカル・サーバーでADDSVRAUTE(サーバー認証項目の追加)コマンド を実行し、特定のローカル・ユーザー に対するリモートのユーザーIDとパスワードを登録 しておけば、接続時の指定を省略できます。
  * ADDSVRAUTEコマンドで登録を行うには、システム値QRETSVRSEC(サーバー機密保護データの保存)を「1=データを保存する」に設定する必要があります。(デフォルトは「0=データを保存しない」)
  * 複数のユーザーが同じリモート・サーバー、および、リモートのユーザーIDとパスワードを使用する場合は、ローカル・ユーザーにグループ・プロファイルを指定し、設定を共有できます。この機能はIBM i 6.1/7.1にはPTFで、7.2以降はベースで提供されます。詳細は「Using a Group Profile in a DDM/DRDA Server Authentication Entry」(https://www.ibm.com/support/pages/using-group-profile-ddmdrda-server-authentication-entry 英文)を参照。
  * 登録済みの設定は、DSPSVRAUTEコマンドで1ユーザーずつ表示します。IBM i 7.2 (SF99702 Level 5以降)であれば、IBM iサービス「QSYS2.DRDA_AUTHENTICATION_ENTRY_INFO」で一覧を取得できます。
* リモート・サーバーが複数存在し、これらにローカル・ユーザーが同一のリモートのユーザーIDとパスワードで接続する場合、ADDSVRAUTEコマンドでリモート・サーバーに特殊値「QDDMDRDASERVER」を登録すれば、全てのリモート・サーバーとのDRDA接続のデフォルトとして、指定したリモートのユーザーIDとパスワードが使用されます。
  * 「QDDMDRDASERVER」特殊値の詳細はIBM Knowledge Center、または、「QDDMDRDASERVER special value in server authentication entries」(https://www.ibm.com/support/pages/qddmdrdaserver-special-value-server-authentication-entries 英文)を参照。

<br>

業務要件に加えて、組織・企業のセキュリティ要件に合致した、適切なDRDA構成の検討をお勧めします。

<p>　</p>

### <u>ワーク6 複数サーバーのIBM iサービスによる管理例</u>

<font color="red">※ DRDAで接続された複数区画／サーバーが必要なため、ワークに使用するサーバーおよびユーザーIDは、ハンズオン指導者がガイドします。必要な環境にアクセスが不可の場合はこのワークをスキップください。</font>

**□ W6-1.** ガイドに基づき、このワーク用サーバーに指定のユーザーIDでサインオン。

* ワーク用IBM iサーバーのIPアドレス：
* ワーク用ユーザーIDとパスワード：

**□ W6-2.** 現行ライブラリーを「LMSVXXLIB」に変更し、「LPARメニュー」を起動。
```
> CHGCURLIB CURLIB(LMSVXXLIB)                 
  {現行ライブラリーが}LMSVXXLIB{に変更された。}
> GO MENU(LPAR)
```

```
 LPAR                            LPAR MENU                                      
                                                                                
  次の中から１つを選んでください:                                               
                                                                                
      1.  区画稼働状況表示                                                      
      2.  区画動作時刻表示                                                      
      3.  区画間システム値比較                                                  
      4.  スプールファイルの処理 (WRKSPLF)                                      
      5.                                                                        
      6.                                                                        
      7.                                                                        
      8.                                                                        
      9.                                                                        
     10.                                                                        
                                                                                
                                                                                
                                                                                
                                                                                
  選択項目またはコマンド                                                        
 ===>                                                                           
                                                                                
 F3= 終了    F4= プロンプト    F9= コマンドの複写    F12= 取り消し              
 F13= 情報援助    F16= システム・メインメニュー                                 
```

**□ W6-3.** オプション1「区画稼働状況表示」を実行し、表示された「LPAR状況の表示」画面から各区画の状態を評価。対応が必要な事項があるかを確認。

**□ W6-4.** オプション2「区画動作時刻表示」を実行し、表示された「LPAR時刻の表示」画面から各区画の状態を評価。対応が必要な事項があるかを確認。

**□ W6-5.** オプション3「区画間システム値比較」を実行し、表示されたスプール・ファイルから各区画のシステム値設定、および、区画間の差異を評価。対応が必要な事項があるかを確認。

**□ W6-6.** (オプション) この資料7.2掲載のソースコードを参照し、プログラム内で利用しているIBM iサービスを確認。
