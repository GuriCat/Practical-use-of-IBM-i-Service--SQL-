# 2 IBM iサービス (SQL) 概要

<p>　</p>

## 2.1 IBM iサービスの定義

最初に「IBM i サービス」の定義を確認しましょう。

![2.1_IBM_i_サービスの定義.jpg](/files/2.1_IBM_i_サービスの定義.jpg)

IBM Knowledge Centerによると、「IBM i サービス」とは、**「システム提供のSQLビュー、プロシージャー、および関数によりアクセスできる多数のシステム・サービス」**をあらわします。新らたなSQLインターフェースをOS(Db2 for i)の一部として提供し、従来システムAPIを使用したプログラムで実現していた機能をSQLで実現できるようにしています。

「IBM i サービス」はIBM i 6.1で初めて実装され、PTF情報など11サービスをPoC(概念実証)的にリリースしています。ユーザーからの反応も好意的でもあり、その後、IBM i のバージョンや、TRレベル、Db2グループPTFレベルが更新される都度、機能が追加・強化され、2019年10月時点では14カテゴリー/96サービスが提供されています。

?> 最新の情報はIBM Knowledge Center (基本的に英語のみ最新情報を反映)を、前提となるIBM iバージョン/PTFレベルは「IBM i Services (SQL)」(https://www.ibm.com/support/pages/ibm-i-services-sql 英文)を参照。

<p>　</p>

### (参考) Db2 for i が提供する機能

IBM iでは「IBM i サービス」以前から、Db2関連のサービスやツールを提供しています。混同を避けるため、これらの提供する機能を下記に示します。

![2.1_参考_Db2_for_i_が提供する機能.jpg](/files/2.1_参考_Db2_for_i_が提供する機能.jpg)

* 「Db2 for i カタログ」は、Db2 for i でサポートされる表、ユーザー定義関数、などの情報を指します。例えば、SYSCATALOGS、SYSCOLUMNS、SYSTABLESなどのビューがあり、DBMSの情報の整合性を維持・管理しています。

?> 相互参照情報(DBクロスリファレンス)に不整合が発生した場合は、RCLDBXREFコマンドで問題のチェック、修復が試行できます。

* 「Db2 for i サービスは」、推奨索引の作成、SQLの取り消しなどの便利機能を提供します。特にPlan Cacheの制御が行えるので、大規模なシステムで大量のSQLを発行しているケースで役に立つでしょう。
* 「ライブラリーSYSTOOLS」はQUSRTOOLのSQL版と言えます。保証なし、サポートなしで提供されており、自由に改変できます。IFSのディレクトリーごとのファイル数を多い順に出力するSQLや、Webサービス利用のためのUDF/UDTFなどが含まれています。

?> ライブラリーSYSTOOLSはリリースアップやPTFで上書きされる場合があるので配慮が必要です。

「IBM i サービス」と、これらの機能を組み合わせれば、SQLを活用して、アプリケーションおよびインフラの維持・管理を効率化できるでしょう。

<p>　</p>

## 2.2 IBM iサービスの用途と位置付け

次に「IBM i サービス」の用途と位置付けを考察します。

用途としては、「IBM i アプリケーション、インフラの維持・運用」が考えられます。現在、そのような用途には、CLコマンドやシステムAPIが利用されています。各手法の簡単な比較を表にしました。

![2.2_IBM_i_サービスの用途と位置付け.jpg](/files/2.2_IBM_i_サービスの用途と位置付け.jpg)

<font size="-2">
*1 印刷出力をCPYSPLFでPF化し、プログラムで特定位置の値を解析している場合などを除く。<br>
*2 基本的に、サービスが終了したIBM i バージョンに新機能は実装されない場合が多い。IBM iサービスは急速に拡充されており、前方互換性が限定的。
</font>

* CLコマンドはIBM i 運用の基本であり、もっとも広く使われています。IBM i のバージョンが変わっても、CLコマンドの仕様変更がアプリケーションに影響する事はまれです。
* システムAPIもCLコマンドと同様に古くから利用されており、非常に広範、かつ、高機能です。CLコマンドで機能や取得できる情報が不足する場合に利用されることが多いでしょう。他方、利用にはプログラミングが必要であり、CLコマンドより敷居が高い面があります。

?> APIの敷居の高さの一例を挙げます。各種情報の取得に、古いシステムAPIはUSRSPC(ユーザースペース)を使用しますが、より新しいAPIはメモリ上のバッファーに取得します。このため、新しいAPIを有効活用するには、ILE言語がサポートする、ポインターや整数型、プロシージャーなどの知識が必要になります。これらのコーディングに精通したプログラマーは多くないでしょう。

* 「IBM i サービス」は多くのサンプルが提供されていることもあり、IBM i とSQLの知識があれば難易度はそれほど高くありません。カバー範囲は限定的ですが、SQLのみでシステムAPIに近い詳細情報が取得できます。

このように「IBM i サービス」は、従来のCLコマンドやシステムAPIを置き換えるものでは無く、新しい選択肢と考えるべきでしょう。

?> なお、「IBM iサービス」とCLコマンドのドキュメントは日本語でKnowledge Centerに記載されていますが、システムAPIは英語のみとなっています。

<p>　</p>

## 2.3 SQLインターフェースの採用

CLコマンドなど従来の手法と比較した時の「IBM i サービス」の最大の特徴は、SQLインターフェースを採用していることです。

SQLインターフェースのメリットとデメリットを考えてみましょう。

**(メリット)**<br>
<font color="blue">
👍並べ替え(Order)、集約(Group)、結合(Join)、トップ10、などの実装が容易<br>
👍複数サーバー(区画)にまたがる処理が比較的容易<br>
👍非定型処理はコーディングレス(SQL直接実行)で結果を得られる<br>
👍国際標準なので技術者が多い(アプリケーション仕様の策定にはIBM iスキル要)<br>
👍実行環境が多彩(IBM i上、CLI/ODBC/JDBC＋Webクライアント上、など)
</font>

**(デメリット)**<br>
<font color="orange">
👎CLやRPGから利用する場合、可変長文字列やヌル値などの考慮が必要<br>
👎組み込みSQL、対話型SQLなどの利用には57xx-ST1が前提
</font>

SQLは高機能、マルチサーバー対応、国際的な標準、実行環境が多彩、というメリットがあります。一方で、CLやRPGから利用するには従来の業務アプリケーションには無かった考慮点があります。また、組み込みSQLなどを利用するには別売りのSQL開発キット(57xx-ST1)が必要です。

CLやAPIが無くなるわけではなく、すでに構築済みの仕組みを「IBM i サービス」に移行しなくてはならないという事はありません。新たに仕組みを作成する場合や、現行の仕組みを改善する場合に、「IBM i サービス」の採用を検討すると良いでしょう。

<p>　</p>

## 2.4 IBM iサービスの機能

ではIBM i 7.4で「IBM i サービス」が提供している機能を見てみましょう。

2020年10月時点で、IBM Knowledge Centerには全14カテゴリー、99サービスにわたって「IBM i サービス」が掲載されています。実行管理、アプリケーション、スプールなどなど、幅広いカテゴリーがカバーされています。

?> 詳細は、IBM Supportの「IBM i Services (SQL)」(https://www.ibm.com/support/pages/ibm-i-services-sql )、あるいは、IBM Knowledge Centerで、ホーム > IBM i 7.4 > データベースパフォーマンスおよびQuery最適化 > IBM i サービス とたどって確認してください。

「IBM i サービス」の多くが表、View、テーブル関数で実装されており、SELECT文で容易に利用できます。

![2.4_IBM_i_サービスの機能.jpg](/files/2.4_IBM_i_サービスの機能.jpg)

前に述べたように、2020年10月現在、全99サービスが利用可能です。QSYS内のコマンドオブジェクトは1,887個、システムAPIは低レベル関数まで含めると3,294あるので、「IBM i サービス」の機能は今後も拡張されるでしょう。

